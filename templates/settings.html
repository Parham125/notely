{% extends "base.html" %}
{% block title %}Settings - Notely{% endblock %}
{% block content %}
<h1>Settings</h1>
{% if success %}
<div class="success">{{success}}</div>
{% endif %}
{% if error %}
<div class="error">{{error}}</div>
{% endif %}
<div class="tabs">
<button class="tab active" data-tab="profile">Profile</button>
<button class="tab" data-tab="sessions">Sessions</button>
<button class="tab" data-tab="danger">Danger Zone</button>
</div>
<div id="profile" class="tab-content">
<h2>Profile Settings</h2>
<div style="margin-bottom:30px;">
<h3>Display Name</h3>
<form method="POST" action="/settings/display-name">
<div class="form-group">
<label for="display_name">Display Name</label>
<input type="text" id="display_name" name="display_name" value="{{user.display_name}}" required>
</div>
<button type="submit" class="btn">Update Display Name</button>
</form>
</div>
<div style="margin-bottom:30px;">
<h3>Profile Picture</h3>
<div style="margin-bottom:20px;">
<img src="{{user|avatar}}" alt="{{user.display_name}}" class="profile-picture">
</div>
<form method="POST" action="/settings/profile-picture" enctype="multipart/form-data">
<div class="form-group">
<label for="file">Upload New Picture</label>
<input type="file" id="file" name="file" accept="image/*">
</div>
<button type="submit" class="btn">Update Picture</button>
</form>
</div>
</div>
<div id="sessions" class="tab-content" style="display:none;">
<h2>Active Sessions</h2>
{% if sessions %}
{% for session in sessions %}
<div class="blog-card" style="display:flex;justify-content:space-between;align-items:center;">
<div>
<div style="font-weight:600;">{{session.browser or "Unknown Browser"}} - {{session.device or "Unknown Device"}}</div>
<div class="blog-meta">
Created: {{session.created_at|timestampformat}} • Last Active: {{session.last_active|timestampformat}}
{% if session.token==current_token %}<span style="color:var(--success);font-weight:600;"> (Current Session)</span>{% endif %}
</div>
</div>
{% if session.token!=current_token %}
<button onclick="deleteSession('{{session.token}}')" class="btn btn-small btn-danger">Delete</button>
{% endif %}
</div>
{% endfor %}
{% else %}
<p>No active sessions.</p>
{% endif %}
</div>
<div id="danger" class="tab-content" style="display:none;">
<h2>Danger Zone</h2>
<div class="danger-section">
<h3>Delete Account</h3>
<div class="warning-box">
<h4>⚠️ Warning: This action is irreversible!</h4>
<p>Deleting your account will permanently remove:</p>
<ul>
<li>All your blog posts and drafts</li>
<li>All your comments on other posts</li>
<li>Your profile information</li>
<li>Your active sessions</li>
</ul>
<p><strong>This action cannot be undone.</strong> Please be certain before proceeding.</p>
</div>
<div id="delete-error" class="error" style="display:none;"></div>
<form id="delete-account-form" method="POST" action="/api/delete-account">
<div class="form-group">
<label for="delete-username">To confirm, type your username: <strong>{{user.username}}</strong></label>
<input type="text" id="delete-username" name="username" required>
</div>
<div class="form-group">
<label for="delete-confirmation">To confirm, type <strong>DELETE</strong> in all caps:</label>
<input type="text" id="delete-confirmation" name="confirmation" required placeholder="DELETE">
</div>
<button type="submit" class="btn btn-danger">Delete My Account</button>
</form>
</div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.querySelectorAll(".tab").forEach(tab=>{
tab.addEventListener("click",()=>{
document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
document.querySelectorAll(".tab-content").forEach(c=>c.style.display="none");
tab.classList.add("active");
document.getElementById(tab.dataset.tab).style.display="block";
});
});

document.getElementById("delete-account-form").addEventListener("submit",function(e){
e.preventDefault();
const username=document.getElementById("delete-username").value.trim();
const confirmation=document.getElementById("delete-confirmation").value.trim();
const errorDiv=document.getElementById("delete-error");
errorDiv.style.display="none";
const formData=new FormData();
formData.append("username",username);
formData.append("confirmation",confirmation);
fetch("/api/delete-account",{method:"POST",body:formData})
.then(response=>response.json())
.then(data=>{
if(data.success){
document.cookie="session_token=; max-age=0; path=/";
window.location.href="/";
}else{
errorDiv.textContent=data.error;
errorDiv.style.display="block";
}
})
.catch(error=>{
errorDiv.textContent="An error occurred. Please try again.";
errorDiv.style.display="block";
});
});
</script>
{% endblock %}
{% block styles %}
<style>
.danger-section {
border: 2px solid var(--danger);
border-radius: 8px;
padding: 20px;
margin-top: 20px;
}
.danger-section h3 {
color: var(--danger);
margin-top: 0;
}
.warning-box {
background: var(--bg-secondary);
border: 1px solid var(--border);
border-radius: 6px;
padding: 15px;
margin-bottom: 20px;
}
.warning-box h4 {
color: var(--danger);
margin-top: 0;
margin-bottom: 10px;
}
.warning-box ul {
margin: 10px 0;
padding-left: 20px;
}
.warning-box li {
margin-bottom: 5px;
}
#delete-account-form .btn-danger {
background: var(--danger);
margin-top: 10px;
}
#delete-account-form .btn-danger:hover {
background: var(--danger-hover);
}
.tab[data-tab="danger"] {
background: var(--danger);
color: white;
}
.tab[data-tab="danger"]:hover {
background: var(--danger-hover);
}
</style>
{% endblock %}
